AMQP ：高级消息队列协议

### 消息通信概念

#### 生产者
生产者创建消息，然后发布到代理服务器

连接到rabbitMQ，通过认证（打开TCP连接），      

在TCP连接内部建立虚拟的==AMQP信道==（channel），一个TCP连接内可以创建多条信道

建立和销毁TCP连接 比较消耗资源，在一条TCP连接上可以创建不限数量的信道

#### 消息
包括两部分： 有效载荷 + 标签

有效载荷会被消费者接收，可以通过 有效载荷 标识消息的生产者

#### 消费者 
连接到代理服务器，订阅队列，接收到消息的有效载荷

消费者收到的每一条消息都必须进行确认，通过 basic.ack 发送接收确认，         
然后消息就会被删除，不会发给其他的消费者

如果没有确认消息，MQ不会继续给这个消费者发送消息，并且会将消息发送给其他的消费者

消费者在收到消息后如果想拒绝消费，可以有两个选择        
1. 把消费者从 MQ服务器断开
2. 使用 basic.reject 的参数requeue ,true表示MQ会把消息发送给下一个消费者，false表示 MQ会移除消息


### AMQP 消息路由（channel）的三部分组成
基于消息的路由键（队列的名称）和交换器类型，服务器会决定消息投递到哪个队列

#### 队列 queue    
队列是 AMQP消息通信的基础模块       

常用参数       
- name      
队列的名称，作为路由键，接受topic消息
 
- exclusive         
true 表示只有一个队列只有一个消费者

- auto-delete    
当最后一个订阅者取消订阅，队列就会自动移除

- durable       
持久化，必须设置为true，为false时会导致MQ重启后重新创建队列

#### 交换器 exchange
消息是发布到交换器上的     

队列通过 路由键（队列的名称） 绑定到交换器，如果路由的消息不匹配任何绑定模式，消息将进入"黑洞"        

服务器会根据 路由键 将消息从交换器 路由到队列

##### 四种不同类型的交换器
- direct（点对点通信）        
匹配路由键（队列名称），消息被投递到对应的队列    

- fanout（）        
把消息投递到所有附加在此交换器上的队列

- topic     
不同的消息源可以到达同一个队列， #表示所有匹配规则

- headers（不重要）      

#### 绑定 binding
交换器和队列的绑定规则


### 虚拟主机

### 消息持久化
如果消息要从 MQ重启后恢复，消息必须
1. 投递模式选项设置为2 （持久）
2. 发送到持久化的交换器（durable 为 true）
3. 达到持久化的队列（durable 为 true）

MQ确保消息能从服务器重启中恢复的方式是 把消息写入磁盘上的一个持久化日志文件，        
当发送一条持久化消息到交换器，Rabbit MQ 会在消息保存到日志文件后发送响应

Rabbit MQ 会在消费者消费后把持久化消息标记为等待垃圾回收

在消费之前，如果 Rabbit MQ重启，Rabbit MQ会重播日志文件中的消息到对应的队列 或者交换器

持久化消息到磁盘会影响吞吐效率

### AMQP事务、 confirm模式
将信道设置为 confirm模式，所有消息会被指派为一个唯一的ID号，     

一旦消息被投递到所有匹配的队列后，Rabbit MQ会发送一个确认标志给生产者，       
如果出现错误，Rabbit MQ会发送nack消息（未确认标志）       

生产者收到确认/未确认标志后执行回调方法，处理后续逻辑


### Rabbit集群
Rabbit集群 允许消费者和生产者在单个Rabbit MQ节点崩溃时 继续运行，       
更多的节点可以线性扩展消息通信的吞吐量

如果集群中唯一的磁盘节点崩溃的话，集群仍然可以保持运行，但是无法更改任何东西      
可以在集群中设置两个磁盘节点

### 负载均衡
软件负载均衡 HAProxy ， 使用轮询算法

不论节点故障什么时候发生，应该重连之后的首要任务是构造交换器、队列、绑定